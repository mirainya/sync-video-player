# 同步视频播放器 - 完整使用指南

## 快速开始

### 启动服务器

```bash
# 1. 启动 WebSocket 服务器（端口 3001）
node server.js

# 2. 启动 Web 服务器（端口 3000）
node web_server.js
```

**当前状态：**
- ✅ WebSocket 服务器运行中：ws://localhost:3001
- ✅ Web 服务器运行中：http://localhost:3000

### 访问应用

在浏览器中打开：**http://localhost:3000**

---

## 功能详解

### 功能1：视频URL解析

**支持的输入类型：**
1. **视频页面URL**（需要解析）
   - 示例：`https://www.agedm.io/play/20100041/3/1`
   - 点击：🔍 解析并加载

2. **直接视频URL**（无需解析）
   - 示例：`https://example.com/video.m3u8`
   - 点击：直接加载 或 🔍 解析并加载（自动识别）

**解析流程：**
```
用户输入URL
    ↓
检测是否为直接视频URL
    ↓ 否
尝试 Cheerio 快速解析（1-2秒）
    ↓ 失败
回退到 Puppeteer 浏览器自动化（3-5秒）
    ↓ 成功
提取视频URL → 自动加载
```

**支持的视频格式：**
- ✅ HLS (.m3u8)
- ✅ MP4 (.mp4)
- ✅ WebM (.webm)
- ✅ OGG (.ogg)

**支持的播放器：**
- ✅ ArtPlayer (5.0.9+)
- ✅ HTML5 原生 video 标签
- ✅ 其他常见播放器（通过网络拦截）

---

### 功能2：房间状态同步

**工作原理：**

```
用户A加载视频
    ↓
通知服务器（video_change消息）
    ↓
服务器更新房间状态
    ↓
广播给所有其他用户
    ↓
用户B/C/D自动加载相同视频
```

**同步的内容：**
- ✅ 视频URL
- ✅ 视频标题
- ✅ 播放进度（currentTime）
- ✅ 播放状态（播放/暂停）
- ✅ 播放速度（playbackRate）

---

## 使用场景

### 场景1：和朋友一起看番剧

**步骤：**
1. **你（主持人）：**
   - 访问 http://localhost:3000
   - 输入昵称，连接服务器
   - 粘贴 agedm.io 视频页面URL
   - 点击 "🔍 解析并加载"
   - 等待3-5秒解析完成
   - 视频自动加载

2. **朋友们：**
   - 访问 http://localhost:3000
   - 输入昵称，连接服务器
   - **自动加载你正在看的视频** 🎉
   - 播放进度自动同步

3. **观看过程：**
   - 任何人点击播放/暂停，所有人同步
   - 任何人拖动进度条，所有人同步
   - 可以发送弹幕和聊天消息
   - 在线用户列表实时更新

### 场景2：切换到下一集

**步骤：**
1. 任何人粘贴新的视频URL
2. 点击 "🔍 解析并加载"
3. **所有人自动切换到新视频** 🎉
4. 聊天室显示："XXX 更换了视频: 新视频标题"

---

## 界面说明

### 主要区域

```
┌─────────────────────────────────────────┐
│  视频播放器                              │
│  [弹幕显示区域]                          │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  连接设置                                │
│  WebSocket服务器: [localhost:3001]      │
│  昵称: [你的昵称]                        │
│  [连接服务器]                            │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  视频加载                                │
│  [📁 选择文件]                           │
│  URL: [输入视频页面URL或直接视频链接]    │
│  [🔍 解析并加载] [直接加载]              │
│  状态: ✅ 解析成功 (puppeteer, 4500ms)   │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  播放控制                                │
│  [▶️ 播放] [⏸️ 暂停] [🔄 同步]          │
│  速度: [1.0x ▼]                          │
└─────────────────────────────────────────┘

┌──────────────┬──────────────────────────┐
│ 在线用户(2)  │  聊天室                  │
│ 👤 用户1     │  [消息列表]              │
│ 👤 用户2     │  [输入框] [发送]         │
└──────────────┴──────────────────────────┘
```

---

## 按钮功能说明

### 视频加载按钮

**🔍 解析并加载**
- 用途：解析视频页面URL，提取真实视频链接
- 适用：agedm.io、bilibili等视频托管网站
- 时间：3-5秒（首次），1-2秒（缓存后）
- 自动识别：如果是直接视频URL，跳过解析

**直接加载**
- 用途：直接加载视频URL（不解析）
- 适用：已知的 .m3u8、.mp4 等直接链接
- 时间：即时

### 播放控制按钮

**▶️ 播放**
- 开始播放视频
- 同步到所有用户

**⏸️ 暂停**
- 暂停视频播放
- 同步到所有用户

**🔄 同步**
- 手动请求同步当前状态
- 用于修复不同步问题

---

## 高级功能

### 弹幕系统

**发送弹幕：**
1. 在弹幕输入框输入内容
2. 选择颜色和大小
3. 点击"发送弹幕"
4. 弹幕在所有用户屏幕上滚动显示

**弹幕设置：**
- 开关：启用/禁用弹幕显示
- 颜色：白色、红色、绿色、蓝色、黄色、紫色
- 大小：小、正常、大

### 聊天系统

**发送消息：**
1. 在聊天输入框输入内容
2. 按回车或点击"发送"
3. 消息显示在所有用户的聊天室

**消息类型：**
- 💬 聊天消息（用户发送）
- 🔔 系统消息（视频切换、用户加入/离开）
- 📝 操作记录（播放、暂停、同步）

---

## 技术细节

### 解析器选择策略

```javascript
if (URL是直接视频链接) {
  跳过解析，直接加载
} else if (method === 'auto') {
  try {
    使用 Cheerio 解析（快速）
  } catch {
    使用 Puppeteer 解析（可靠）
  }
}
```

### 房间状态结构

```javascript
{
  currentTime: 123.45,        // 当前播放时间（秒）
  paused: false,              // 是否暂停
  playbackRate: 1.0,          // 播放速度
  videoUrl: "https://...",    // 视频URL
  videoTitle: "视频标题"       // 视频标题
}
```

### WebSocket消息类型

**客户端 → 服务器：**
- `play` - 播放视频
- `pause` - 暂停视频
- `seek` - 跳转进度
- `ratechange` - 改变速度
- `video_change` - 更换视频 ⭐
- `chat` - 聊天消息
- `danmaku` - 弹幕消息

**服务器 → 客户端：**
- `sync` - 同步状态
- `video_change` - 视频变更通知 ⭐
- `users_update` - 用户列表更新
- `user_joined` - 用户加入
- `user_left` - 用户离开

---

## 故障排除

### 问题1：解析失败

**症状：** 点击"解析并加载"后显示"❌ 解析失败"

**解决方案：**
1. 检查URL是否正确
2. 尝试直接访问该URL，确认页面可访问
3. 查看浏览器控制台错误信息
4. 检查服务器日志

### 问题2：新用户加入后没有自动加载视频

**症状：** 新用户连接后看到空白播放器

**解决方案：**
1. 确认是否有人已经加载了视频
2. 检查WebSocket连接状态（应显示"已连接"）
3. 刷新页面重新连接
4. 查看浏览器控制台是否有错误

### 问题3：视频不同步

**症状：** 不同用户看到的播放进度不一致

**解决方案：**
1. 点击"🔄 同步"按钮手动同步
2. 检查网络连接是否稳定
3. 确认所有用户连接到同一服务器
4. 刷新页面重新连接

### 问题4：HLS视频无法播放

**症状：** m3u8 视频加载失败

**解决方案：**
1. 确认浏览器支持HLS（Chrome、Firefox、Edge）
2. 检查视频URL是否有效
3. 查看浏览器控制台的HLS错误信息
4. 尝试使用Safari（原生支持HLS）

---

## 性能优化

### 浏览器实例复用
- Puppeteer浏览器实例在多次解析间保持活跃
- 首次解析：4-5秒
- 后续解析：1-2秒

### 资源拦截
- 解析时自动拦截图片、字体、样式表
- 减少加载时间约50%

### 并发限制
- 最多3个并发Puppeteer解析任务
- 防止内存溢出

---

## 安全说明

### 适用场景
✅ 个人使用
✅ 小团队（<10人）
✅ 局域网内使用
✅ 可信任的用户群体

### 不适用场景
❌ 公开互联网服务
❌ 大规模用户（>50人）
❌ 商业用途
❌ 不可信用户

### 安全建议
- 仅在可信网络中使用
- 不要暴露到公网
- 定期更新依赖包
- 监控服务器资源使用

---

## 开发者信息

### 项目结构
```
sync-video-player/
├── server.js              # WebSocket服务器
├── web_server.js          # HTTP服务器
├── parsers/               # 视频解析器
│   ├── index.js          # 主协调器
│   ├── cheerio-parser.js # 快速HTML解析
│   ├── puppeteer-parser.js # 浏览器自动化
│   └── utils.js          # 工具函数
├── public/               # 前端文件
│   ├── index.html        # 主页面
│   └── script.js         # 客户端逻辑
└── package.json          # 依赖配置
```

### 依赖包
- `express` - Web服务器
- `ws` - WebSocket服务器
- `puppeteer` - 浏览器自动化
- `cheerio` - HTML解析
- `axios` - HTTP客户端
- `hls.js` - HLS播放支持

### API端点
- `GET /` - 主页面
- `POST /api/parse-video` - 视频解析API

---

## 更新日志

### v2.0 (当前版本)
- ✅ 添加视频URL解析功能
- ✅ 支持ArtPlayer 5.0.9
- ✅ 实现房间状态同步
- ✅ 新用户自动加载当前视频
- ✅ 视频切换实时同步

### v1.0
- ✅ 基础同步播放功能
- ✅ 弹幕系统
- ✅ 聊天系统
- ✅ 在线用户列表

---

## 联系与支持

如有问题或建议，请查看：
- 测试指南：`ROOM_SYNC_TEST.md`
- 服务器日志：查看后台任务输出
- 浏览器控制台：F12 开发者工具

---

**享受同步观看的乐趣！** 🎉
