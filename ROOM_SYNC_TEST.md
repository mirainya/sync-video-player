# 房间状态同步功能测试指南

## 测试环境
- WebSocket服务器：ws://localhost:3001
- Web服务器：http://localhost:3000

## 测试场景

### 场景1：基础同步测试

**步骤：**
1. 打开浏览器窗口A，访问 http://localhost:3000
2. 连接到服务器（输入昵称，点击"连接服务器"）
3. 加载一个视频（例如：https://www.agedm.io/play/20100041/3/1）
4. 打开浏览器窗口B（隐身模式或另一个浏览器）
5. 访问 http://localhost:3000
6. 连接到服务器

**预期结果：**
- ✅ 窗口B连接后，自动加载窗口A正在播放的视频
- ✅ 窗口B的视频播放进度与窗口A同步
- ✅ 聊天室显示"用户X 加入了房间"

### 场景2：视频切换同步测试

**步骤：**
1. 两个窗口都已连接并观看同一视频
2. 在窗口A中加载新视频
3. 观察窗口B的变化

**预期结果：**
- ✅ 窗口B自动切换到新视频
- ✅ 聊天室显示"XXX 更换了视频: 视频标题"
- ✅ 所有用户的播放进度重置为0

### 场景3：多用户同步测试

**步骤：**
1. 打开3个或更多浏览器窗口
2. 第一个窗口加载视频并播放
3. 其他窗口依次连接

**预期结果：**
- ✅ 所有后加入的窗口都自动加载相同视频
- ✅ 播放/暂停操作在所有窗口同步
- ✅ 任何窗口更换视频，其他窗口都跟随

### 场景4：解析功能集成测试

**步骤：**
1. 窗口A使用"解析并加载"功能
2. 输入 agedm.io 页面URL
3. 等待解析完成
4. 窗口B观察变化

**预期结果：**
- ✅ 解析成功后，窗口A加载视频
- ✅ 窗口B自动加载相同的解析后视频
- ✅ 视频URL显示在输入框中

## 调试技巧

### 查看服务器日志
```bash
# WebSocket服务器日志
type C:\Users\mirai\AppData\Local\Temp\claude\F--free-sync-video-player\tasks\b911f57.output

# Web服务器日志
type C:\Users\mirai\AppData\Local\Temp\claude\F--free-sync-video-player\tasks\b7eeec3.output
```

### 浏览器控制台
打开开发者工具（F12），查看：
- 网络请求（Network）
- WebSocket消息（WS）
- 控制台日志（Console）

### 关键日志消息
- `[API] Parse request:` - 视频解析请求
- `[Parser] Puppeteer succeeded:` - 解析成功
- `视频已更改:` - 服务器记录视频变更
- `收到视频变更通知:` - 客户端收到通知
- `检测到视频URL变化，自动加载:` - 自动加载触发

## 常见问题

### Q: 新用户加入后没有自动加载视频
**A:** 检查：
1. 是否有人已经加载了视频
2. WebSocket连接是否成功
3. 浏览器控制台是否有错误

### Q: 视频切换不同步
**A:** 检查：
1. 所有用户是否都连接到同一服务器
2. 网络连接是否稳定
3. 浏览器是否支持HLS播放

### Q: 解析后的视频没有同步
**A:** 确认：
1. 解析成功后是否点击了"加载"按钮
2. WebSocket连接状态是否为"已连接"
3. 服务器日志中是否有 video_change 消息

## 性能指标

- **连接建立时间**: < 1秒
- **视频同步延迟**: < 500ms
- **状态同步频率**: 1秒/次（播放时）
- **视频切换时间**: 取决于视频加载速度

## 成功标准

✅ 新用户加入自动加载当前视频
✅ 视频切换实时同步到所有用户
✅ 播放状态（播放/暂停/进度）同步
✅ 系统消息正确显示
✅ 多用户并发无冲突
